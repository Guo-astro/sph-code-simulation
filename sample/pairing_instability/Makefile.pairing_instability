# Pairing Instability Makefile Targets - Multi-Method Comparison System
#
# Single Method Usage:
#   make pairing_run                               # Run pairing instability (SSPH)
#   make pairing_clean                             # Clean results
#
# Multi-Method Comparison:
#   make pairing_compare_run                       # Run all 5 SPH methods
#   make pairing_compare_viz                       # Generate comparison plots
#   make pairing_compare_animate                   # Generate comparison animation
#   make pairing_compare_all                       # Run all methods + visualizations
#   make pairing_compare_clean                     # Clean comparison results

# Default preset
PAIRING_PRESET ?= pairing_instability_ssph

# Paths
PAIRING_DIR = sample/pairing_instability
PRESET_DIR = $(PAIRING_DIR)/config/presets
RESULTS_DIR = $(PAIRING_DIR)/results

.PHONY: pairing_run pairing_clean pairing_help \
        pairing_compare_run pairing_compare_viz pairing_compare_animate \
        pairing_compare_all pairing_compare_clean

# Run pairing instability simulation
pairing_run: build/sph
	@echo "=========================================="
	@echo "Pairing Instability: $(PAIRING_PRESET)"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "^#define DIM 2" include/defines.hpp; then \
		echo "âœ“ DIM=2 build detected"; \
	else \
		echo "âŒ ERROR: Pairing instability requires DIM=2 build"; \
		echo ""; \
		echo "Current build is configured for DIM=$$(grep '^#define DIM' include/defines.hpp | awk '{print $$3}')."; \
		echo "Pairing instability is a 2D test case and requires DIM=2."; \
		echo ""; \
		echo "To rebuild for 2D:"; \
		echo "  sed -i '' 's/#define DIM [0-9]/#define DIM 2/' include/defines.hpp"; \
		echo "  cd build && make -j8 && cd .."; \
		echo ""; \
		exit 1; \
	fi
	@echo "Applying preset configuration..."
	@cp $(PRESET_DIR)/$(PAIRING_PRESET).json $(PAIRING_DIR)/pairing_instability.json
	@echo "Output directory:"
	@grep -o '"outputDirectory"[[:space:]]*:[[:space:]]*"[^"]*"' $(PAIRING_DIR)/pairing_instability.json | sed 's/.*: *"\(.*\)"/  ðŸ“ \1/'
	@echo "Creating results directory..."
	@mkdir -p $(RESULTS_DIR)
	@echo "Running simulation..."
	./build/sph pairing_instability
	@echo ""
	@echo "âœ“ Simulation complete!"
	@echo "ðŸ“ Results saved to: $(RESULTS_DIR)"

# Clean results
pairing_clean:
	@echo "Cleaning pairing instability results..."
	@rm -rf $(RESULTS_DIR)
	@echo "âœ“ Results cleaned"

# Help
pairing_help:
	@echo "Pairing Instability Makefile Targets"
	@echo "====================================="
	@echo ""
	@echo "Single Method Targets:"
	@echo "  pairing_run     - Run pairing instability (SSPH)"
	@echo "  pairing_clean   - Clean results"
	@echo ""
	@echo "Multi-Method Comparison Targets:"
	@echo "  pairing_compare_run     - Run all 5 SPH methods (GSPH, SSPH, DISPH, GDISPH, GDISPH+Balsara)"
	@echo "  pairing_compare_viz     - Generate comparison plots"
	@echo "  pairing_compare_animate - Generate comparison animation"
	@echo "  pairing_compare_all     - Run all + generate visualizations"
	@echo "  pairing_compare_clean   - Clean all comparison results"
	@echo ""
	@echo "Examples:"
	@echo "  make pairing_run"
	@echo "  make pairing_compare_all"

# ============================================================================
# Multi-Method Comparison Targets
# ============================================================================

# Run all five SPH methods (GSPH, SSPH, DISPH, GDISPH, GDISPH+Balsara)
pairing_compare_run: build/sph
	@echo "=========================================="
	@echo "Pairing Instability Multi-Method Comparison"
	@echo "Running: GSPH, SSPH, DISPH, GDISPH, GDISPH+Balsara"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "^#define DIM 2" include/defines.hpp; then \
		echo "âœ“ DIM=2 build detected"; \
	else \
		echo "âŒ ERROR: Pairing instability requires DIM=2 build"; \
		echo "See instructions above."; \
		exit 1; \
	fi
	@echo ""
	@echo "[1/5] Running GSPH simulation..."
	@echo "----------------------------------------"
	@cp $(PRESET_DIR)/pairing_instability_gsph.json $(PAIRING_DIR)/pairing_instability.json
	@mkdir -p $(RESULTS_DIR)/gsph
	@./build/sph pairing_instability
	@echo "âœ“ GSPH complete"
	@echo ""
	@echo "[2/5] Running SSPH simulation..."
	@echo "----------------------------------------"
	@cp $(PRESET_DIR)/pairing_instability_ssph.json $(PAIRING_DIR)/pairing_instability.json
	@mkdir -p $(RESULTS_DIR)/ssph
	@./build/sph pairing_instability
	@echo "âœ“ SSPH complete"
	@echo ""
	@echo "[3/5] Running DISPH simulation..."
	@echo "----------------------------------------"
	@cp $(PRESET_DIR)/pairing_instability_disph.json $(PAIRING_DIR)/pairing_instability.json
	@mkdir -p $(RESULTS_DIR)/disph
	@./build/sph pairing_instability
	@echo "âœ“ DISPH complete"
	@echo ""
	@echo "[4/5] Running GDISPH simulation..."
	@echo "----------------------------------------"
	@cp $(PRESET_DIR)/pairing_instability_gdisph.json $(PAIRING_DIR)/pairing_instability.json
	@mkdir -p $(RESULTS_DIR)/gdisph
	@./build/sph pairing_instability
	@echo "âœ“ GDISPH complete"
	@echo ""
	@echo "[5/5] Running GDISPH+Balsara simulation..."
	@echo "----------------------------------------"
	@cp $(PRESET_DIR)/pairing_instability_gdisph_balsara.json $(PAIRING_DIR)/pairing_instability.json
	@mkdir -p $(RESULTS_DIR)/gdisph_balsara
	@./build/sph pairing_instability
	@echo "âœ“ GDISPH+Balsara complete"
	@echo ""
	@echo "=========================================="
	@echo "âœ“ All simulations complete!"
	@echo "=========================================="
	@echo "Results directories:"
	@echo "  ðŸ“ $(RESULTS_DIR)/gsph/"
	@echo "  ðŸ“ $(RESULTS_DIR)/ssph/"
	@echo "  ðŸ“ $(RESULTS_DIR)/disph/"
	@echo "  ðŸ“ $(RESULTS_DIR)/gdisph/"
	@echo "  ðŸ“ $(RESULTS_DIR)/gdisph_balsara/"
	@echo ""
	@echo "Next steps:"
	@echo "  make pairing_compare_viz     - Generate comparison plots"
	@echo "  make pairing_compare_animate - Generate animation"

# Generate comparison plots
pairing_compare_viz:
	@echo "=========================================="
	@echo "Generating Comparison Plots"
	@echo "=========================================="
	@if [ ! -d "$(RESULTS_DIR)/gsph" ] || [ ! -d "$(RESULTS_DIR)/ssph" ] || [ ! -d "$(RESULTS_DIR)/disph" ] || [ ! -d "$(RESULTS_DIR)/gdisph" ] || [ ! -d "$(RESULTS_DIR)/gdisph_balsara" ]; then \
		echo "ERROR: Missing results directories"; \
		echo "Run 'make pairing_compare_run' first."; \
		exit 1; \
	fi
	@mkdir -p $(RESULTS_DIR)/comparison
	@python3 $(PAIRING_DIR)/scripts/compare_pairing.py $(RESULTS_DIR) $(RESULTS_DIR)/comparison
	@echo ""
	@echo "âœ“ Comparison plots generated!"
	@echo "ðŸ“Š Output: $(RESULTS_DIR)/comparison/"
	@ls -lh $(RESULTS_DIR)/comparison/*.png 2>/dev/null || true

# Generate comparison animation
pairing_compare_animate:
	@echo "=========================================="
	@echo "Generating Comparison Animation"
	@echo "=========================================="
	@if [ ! -d "$(RESULTS_DIR)/gsph" ] || [ ! -d "$(RESULTS_DIR)/ssph" ] || [ ! -d "$(RESULTS_DIR)/disph" ] || [ ! -d "$(RESULTS_DIR)/gdisph" ] || [ ! -d "$(RESULTS_DIR)/gdisph_balsara" ]; then \
		echo "ERROR: Missing results directories"; \
		echo "Run 'make pairing_compare_run' first."; \
		exit 1; \
	fi
	@mkdir -p $(RESULTS_DIR)/comparison
	@python3 $(PAIRING_DIR)/scripts/animate_pairing.py $(RESULTS_DIR) $(RESULTS_DIR)/comparison/comparison_animation.gif
	@echo ""
	@echo "âœ“ Animation complete!"
	@echo "ðŸŽ¬ Output: $(RESULTS_DIR)/comparison/comparison_animation.gif"
	@ls -lh $(RESULTS_DIR)/comparison/comparison_animation.gif 2>/dev/null || true

# Run all comparisons and generate all visualizations
pairing_compare_all: pairing_compare_run pairing_compare_viz pairing_compare_animate
	@echo ""
	@echo "=========================================="
	@echo "âœ“ Complete Comparison Workflow Done!"
	@echo "=========================================="
	@echo "All results in: $(RESULTS_DIR)/comparison/"

# Clean all comparison results
pairing_compare_clean:
	@echo "Cleaning all pairing instability comparison results..."
	@rm -rf $(RESULTS_DIR)/gsph $(RESULTS_DIR)/ssph $(RESULTS_DIR)/disph $(RESULTS_DIR)/gdisph $(RESULTS_DIR)/gdisph_balsara $(RESULTS_DIR)/comparison
	@echo "âœ“ All comparison results cleaned"
