# Shock Tube Makefile Targets - Single Source of Truth System
#
# Single Method Usage:
#   make shock_tube_run                                # Run Sod shock tube test (SSPH)
#   make shock_tube_resume                             # Resume from latest snapshot
#   make shock_tube_resume CHECKPOINT=snapshot_0005.csv # Resume from specific snapshot
#   make shock_tube_clean                              # Clean results
#
# Multi-Method Comparison:
#   make shock_tube_compare_run                        # Run GSPH, SSPH, DISPH simulations
#   make shock_tube_compare_viz                        # Generate comparison plots
#   make shock_tube_compare_animate                    # Generate comparison animation
#   make shock_tube_compare_all                        # Run all methods + visualizations
#   make shock_tube_compare_clean                      # Clean comparison results

# Default preset (only for shock_tube targets)
ifeq ($(filter lane_emden%,$(MAKECMDGOALS)),)
PRESET ?= shock_tube_1d_sod
endif

# Paths
SHOCK_TUBE_DIR = sample/shock_tube
PRESET_DIR = $(SHOCK_TUBE_DIR)/config/presets
RESULTS_DIR = $(SHOCK_TUBE_DIR)/results

.PHONY: shock_tube_run shock_tube_resume shock_tube_clean shock_tube_help shock_tube_animate \
        shock_tube_compare_run shock_tube_compare_viz shock_tube_compare_animate \
        shock_tube_compare_all shock_tube_compare_clean

# Run shock tube simulation
shock_tube_run: build/sph
	@echo "=========================================="
	@echo "Shock Tube: $(PRESET)"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "^#define DIM 1" include/defines.hpp; then \
		echo "âœ“ DIM=1 build detected"; \
	else \
		echo "âŒ ERROR: Shock tube requires DIM=1 build"; \
		echo ""; \
		echo "Current build is configured for DIM=3 (3D simulations)."; \
		echo "Shock tube is a 1D test case and requires DIM=1."; \
		echo ""; \
		echo "To rebuild for 1D:"; \
		echo "  sed -i '' 's/#define DIM 3/#define DIM 1/' include/defines.hpp"; \
		echo "  cd build && make -j8 && cd .."; \
		echo ""; \
		echo "To restore 3D build after shock tube:"; \
		echo "  sed -i '' 's/#define DIM 1/#define DIM 3/' include/defines.hpp"; \
		echo "  cd build && make -j8 && cd .."; \
		echo ""; \
		echo "See sample/shock_tube/README.md for details."; \
		exit 1; \
	fi
	@echo "Applying preset configuration..."
	@cp $(PRESET_DIR)/$(PRESET).json $(SHOCK_TUBE_DIR)/shock_tube.json
	@echo "Output directory:"
	@python3 -c "import json; print('  ðŸ“ ' + json.load(open('$(SHOCK_TUBE_DIR)/shock_tube.json'))['outputDirectory'])"
	@echo "Creating results directory..."
	@mkdir -p $(RESULTS_DIR)
	@echo "Running simulation..."
	./build/sph shock_tube
	@echo ""
	@echo "âœ“ Simulation complete!"
	@echo "ðŸ“ Results saved to: $(RESULTS_DIR)"

# Resume from checkpoint
shock_tube_resume: build/sph
	@echo "=========================================="
	@echo "Shock Tube Resume from Checkpoint"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "^#define DIM 1" include/defines.hpp; then \
		echo "âœ“ DIM=1 build detected"; \
	else \
		echo "âŒ ERROR: Shock tube requires DIM=1 build"; \
		echo "See sample/shock_tube/README.md for details."; \
		exit 1; \
	fi
	@if [ -z "$(CHECKPOINT)" ]; then \
		echo "No CHECKPOINT specified, finding latest snapshot..."; \
		LATEST=$$(ls -t $(RESULTS_DIR)/snapshot_*.csv 2>/dev/null | head -1); \
		if [ -z "$$LATEST" ]; then \
			echo "ERROR: No snapshots found in $(RESULTS_DIR)/"; \
			echo ""; \
			echo "Usage:"; \
			echo "  make shock_tube_resume                              # Use latest snapshot"; \
			echo "  make shock_tube_resume CHECKPOINT=snapshot_0005.csv # Use specific snapshot"; \
			echo ""; \
			exit 1; \
		fi; \
		echo "âœ“ Found latest snapshot: $$LATEST"; \
		$(MAKE) shock_tube_resume CHECKPOINT=$$LATEST; \
	else \
		echo "Checkpoint file: $(CHECKPOINT)"; \
		echo ""; \
		echo "Creating resume configuration (SSOT mode)..."; \
		python3 -c "import json; \
			resume_config = { \
				'checkpoint': {'resumeFile': '$(CHECKPOINT)'}, \
				'outputDirectory': '$(RESULTS_DIR)', \
				'endTime': 0.4, \
				'outputTime': 0.01 \
			}; \
			json.dump(resume_config, open('$(SHOCK_TUBE_DIR)/shock_tube.json', 'w'), indent=2)"; \
		echo "âœ“ Resume config created"; \
		echo ""; \
		echo "Running simulation from checkpoint..."; \
		./build/sph shock_tube; \
		echo ""; \
		echo "âœ“ Resumed simulation complete!"; \
		echo "ðŸ“ Results saved to: $(RESULTS_DIR)"; \
	fi

# Clean results
shock_tube_clean:
	@echo "Cleaning shock tube results..."
	@rm -rf $(RESULTS_DIR)
	@echo "âœ“ Results cleaned"

# Visualize results
shock_tube_animate:
	@echo "=========================================="
	@echo "Visualizing Shock Tube Results"
	@echo "=========================================="
	@if [ ! -d "$(RESULTS_DIR)" ] || [ -z "$$(ls -A $(RESULTS_DIR)/snapshot_*.csv 2>/dev/null)" ]; then \
		echo "ERROR: No results found in $(RESULTS_DIR)/"; \
		echo "Run 'make shock_tube_run' first to generate data."; \
		exit 1; \
	fi
	@echo "Data directory: $(RESULTS_DIR)"
	@python3 $(SHOCK_TUBE_DIR)/scripts/visualize_shock_tube.py $(RESULTS_DIR) shock_tube_sod
	@echo ""
	@echo "âœ“ Visualization complete!"
	@echo "ðŸ“Š Generated files in $(RESULTS_DIR):"
	@ls -lh $(RESULTS_DIR)/shock_tube_sod_*.png $(RESULTS_DIR)/shock_tube_sod_*.gif 2>/dev/null || true

# Help
shock_tube_help:
	@echo "Shock Tube Makefile Targets"
	@echo "============================"
	@echo ""
	@echo "Single Method Targets:"
	@echo "  shock_tube_run     - Run Sod shock tube test (SSPH)"
	@echo "  shock_tube_resume  - Resume from latest snapshot"
	@echo "  shock_tube_animate - Generate plots and animation"
	@echo "  shock_tube_clean   - Clean results"
	@echo ""
	@echo "Multi-Method Comparison Targets:"
	@echo "  shock_tube_compare_run     - Run all SPH methods (GSPH, SSPH, DISPH)"
	@echo "  shock_tube_compare_viz     - Generate comparison plots"
	@echo "  shock_tube_compare_animate - Generate comparison animation"
	@echo "  shock_tube_compare_all     - Run all + generate visualizations"
	@echo "  shock_tube_compare_clean   - Clean all comparison results"
	@echo ""
	@echo "Examples:"
	@echo "  make shock_tube_run"
	@echo "  make shock_tube_compare_all"
	@echo "  make shock_tube_resume CHECKPOINT=sample/shock_tube/results/snapshot_0005.csv"

# ============================================================================
# Multi-Method Comparison Targets
# ============================================================================

# Run all four SPH methods (GSPH, SSPH, DISPH, GDISPH)
shock_tube_compare_run: build/sph
	@echo "=========================================="
	@echo "Shock Tube Multi-Method Comparison"
	@echo "Running: GSPH, SSPH, DISPH, GDISPH"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "^#define DIM 1" include/defines.hpp; then \
		echo "âœ“ DIM=1 build detected"; \
	else \
		echo "âŒ ERROR: Shock tube requires DIM=1 build"; \
		echo "See sample/shock_tube/README.md for details."; \
		exit 1; \
	fi
	@echo ""
	@echo "[1/3] Running GSPH simulation..."
	@echo "----------------------------------------"
	@cp $(PRESET_DIR)/shock_tube_1d_gsph.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(RESULTS_DIR)/gsph
	@./build/sph shock_tube
	@echo "âœ“ GSPH complete"
	@echo ""
	@echo "[2/3] Running SSPH simulation..."
	@echo "----------------------------------------"
	@cp $(PRESET_DIR)/shock_tube_1d_ssph.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(RESULTS_DIR)/ssph
	@./build/sph shock_tube
	@echo "âœ“ SSPH complete"
	@echo ""
	@echo "[3/4] Running DISPH simulation..."
	@echo "----------------------------------------"
	@cp $(PRESET_DIR)/shock_tube_1d_disph.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(RESULTS_DIR)/disph
	@./build/sph shock_tube
	@echo "âœ“ DISPH complete"
	@echo ""
	@echo "[4/4] Running GDISPH simulation..."
	@echo "----------------------------------------"
	@cp $(PRESET_DIR)/shock_tube_1d_gdisph.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(RESULTS_DIR)/gdisph
	@./build/sph shock_tube
	@echo "âœ“ GDISPH complete"
	@echo ""
	@echo "=========================================="
	@echo "âœ“ All simulations complete!"
	@echo "=========================================="
	@echo "Results directories:"
	@echo "  ðŸ“ $(RESULTS_DIR)/gsph/"
	@echo "  ðŸ“ $(RESULTS_DIR)/ssph/"
	@echo "  ðŸ“ $(RESULTS_DIR)/disph/"
	@echo "  ðŸ“ $(RESULTS_DIR)/gdisph/"
	@echo ""
	@echo "Next steps:"
	@echo "  make shock_tube_compare_viz     - Generate comparison plots"
	@echo "  make shock_tube_compare_animate - Generate animation"

# Generate comparison plots
shock_tube_compare_viz:
	@echo "=========================================="
	@echo "Generating Comparison Plots"
	@echo "=========================================="
	@if [ ! -d "$(RESULTS_DIR)/gsph" ] || [ ! -d "$(RESULTS_DIR)/ssph" ] || [ ! -d "$(RESULTS_DIR)/disph" ]; then \
		echo "ERROR: Missing results directories"; \
		echo "Run 'make shock_tube_compare_run' first."; \
		exit 1; \
	fi
	@mkdir -p $(RESULTS_DIR)/comparison
	@python3 $(SHOCK_TUBE_DIR)/scripts/compare_shock_tube.py $(RESULTS_DIR) $(RESULTS_DIR)/comparison
	@echo ""
	@echo "âœ“ Comparison plots generated!"
	@echo "ðŸ“Š Output: $(RESULTS_DIR)/comparison/"
	@ls -lh $(RESULTS_DIR)/comparison/*.png 2>/dev/null || true

# Generate comparison animation
shock_tube_compare_animate:
	@echo "=========================================="
	@echo "Generating Comparison Animation"
	@echo "=========================================="
	@if [ ! -d "$(RESULTS_DIR)/gsph" ] || [ ! -d "$(RESULTS_DIR)/ssph" ] || [ ! -d "$(RESULTS_DIR)/disph" ] || [ ! -d "$(RESULTS_DIR)/gdisph" ]; then \
		echo "ERROR: Missing results directories"; \
		echo "Run 'make shock_tube_compare_run' first."; \
		exit 1; \
	fi
	@mkdir -p $(RESULTS_DIR)/comparison
	@python3 $(SHOCK_TUBE_DIR)/scripts/animate_comparison.py $(RESULTS_DIR) $(RESULTS_DIR)/comparison/comparison_animation.gif
	@echo ""
	@echo "âœ“ Animation complete!"
	@echo "ðŸŽ¬ Output: $(RESULTS_DIR)/comparison/comparison_animation.gif"
	@ls -lh $(RESULTS_DIR)/comparison/*.gif 2>/dev/null || true

# Run all methods and generate all visualizations
shock_tube_compare_all: shock_tube_compare_run shock_tube_compare_viz shock_tube_compare_animate
	@echo ""
	@echo "=========================================="
	@echo "âœ“ Full Comparison Study Complete!"
	@echo "=========================================="
	@echo "ðŸ“ All outputs saved to: $(RESULTS_DIR)/"
	@echo ""
	@echo "Generated files:"
	@echo "  Data:"
	@echo "    $(RESULTS_DIR)/gsph/snapshot_*.csv"
	@echo "    $(RESULTS_DIR)/ssph/snapshot_*.csv"
	@echo "    $(RESULTS_DIR)/disph/snapshot_*.csv"
	@echo "    $(RESULTS_DIR)/gdisph/snapshot_*.csv"
	@echo "  Comparison Plots:"
	@ls $(RESULTS_DIR)/comparison/*.png 2>/dev/null | sed 's/^/    /' || true
	@echo "  Comparison Animation:"
	@ls $(RESULTS_DIR)/comparison/*.gif 2>/dev/null | sed 's/^/    /' || true

# Clean all comparison results
shock_tube_compare_clean:
	@echo "Cleaning all comparison results..."
	@rm -rf $(RESULTS_DIR)/gsph $(RESULTS_DIR)/ssph $(RESULTS_DIR)/disph $(RESULTS_DIR)/gdisph $(RESULTS_DIR)/comparison
	@echo "âœ“ Comparison results cleaned"
