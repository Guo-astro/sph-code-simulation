# Shock Tube Makefile Targets - Single Source of Truth System
#
# Single Method Usage:
#   make shock_tube_run                                # Run Sod shock tube test (SSPH)
#   make shock_tube_resume                             # Resume from latest snapshot
#   make shock_tube_resume CHECKPOINT=snapshot_0005.csv # Resume from specific snapshot
#   make shock_tube_animate                            # Generate plots and animation
#   make shock_tube_clean                              # Clean results
#
# Riemann Solver Comparison:
#   make shock_tube_iterative_run                      # Run GSPH with iterative solver
#   make shock_tube_iterative_animate                  # Animate iterative solver results
#   make shock_tube_iterative_all                      # Run iterative + visualize (one-shot)
#   make shock_tube_hll_run                            # Run GSPH with HLL solver
#   make shock_tube_hll_animate                        # Animate HLL solver results
#   make shock_tube_riemann_compare                    # Compare HLL vs Iterative
#
# Multi-Method Comparison:
#   make shock_tube_compare_run                        # Run GSPH, SSPH, DISPH, GDISPH, GDISPH+Balsara
#   make shock_tube_compare_viz                        # Generate comparison plots
#   make shock_tube_compare_animate                    # Generate comparison animation
#   make shock_tube_compare_all                        # Run all methods + visualizations
#   make shock_tube_compare_clean                      # Clean comparison results

# Default preset (only for shock_tube targets)
ifeq ($(filter lane_emden%,$(MAKECMDGOALS)),)
PRESET ?= shock_tube_1d_sod
endif

# Paths
SHOCK_TUBE_DIR = sample/shock_tube
SHOCK_TUBE_PRESET_DIR = $(SHOCK_TUBE_DIR)/config/presets
SHOCK_TUBE_RESULTS_DIR = $(SHOCK_TUBE_DIR)/results

.PHONY: shock_tube_run shock_tube_resume shock_tube_clean shock_tube_help shock_tube_animate \
        shock_tube_compare_run shock_tube_compare_viz shock_tube_compare_animate \
        shock_tube_compare_all shock_tube_compare_clean \
        shock_tube_iterative_run shock_tube_iterative_animate shock_tube_iterative_all \
        shock_tube_hll_run shock_tube_hll_animate shock_tube_riemann_compare

# Run shock tube simulation
shock_tube_run: build/sph
	@echo "=========================================="
	@echo "Shock Tube: $(PRESET)"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "SPH_DIM:STRING=1" build/CMakeCache.txt 2>/dev/null; then \
		echo "âœ“ DIM=1 build detected"; \
	else \
		echo "âŒ ERROR: Shock tube requires DIM=1 build"; \
		echo ""; \
		echo "Shock tube is a 1D test case and requires DIM=1."; \
		echo ""; \
		echo "To rebuild for 1D:"; \
		echo "  cd build && cmake -DSPH_DIM=1 .. && make -j8 && cd .."; \
		echo ""; \
		echo "To restore 3D build after shock tube:"; \
		echo "  cd build && cmake -DSPH_DIM=3 .. && make -j8 && cd .."; \
		echo ""; \
		echo "See sample/shock_tube/README.md for details."; \
		exit 1; \
	fi
	@echo "Applying preset configuration..."
	@cp $(SHOCK_TUBE_PRESET_DIR)/$(PRESET).json $(SHOCK_TUBE_DIR)/shock_tube.json
	@echo "Output directory:"
	@python3 -c "import json; print('  ðŸ“ ' + json.load(open('$(SHOCK_TUBE_DIR)/shock_tube.json'))['outputDirectory'])"
	@echo "Creating results directory..."
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)
	@echo "Running simulation..."
	./build/sph shock_tube
	@echo ""
	@echo "âœ“ Simulation complete!"
	@echo "ðŸ“ Results saved to: $(SHOCK_TUBE_RESULTS_DIR)"

# Resume from checkpoint
shock_tube_resume: build/sph
	@echo "=========================================="
	@echo "Shock Tube Resume from Checkpoint"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "SPH_DIM:STRING=1" build/CMakeCache.txt 2>/dev/null; then \
		echo "âœ“ DIM=1 build detected"; \
	else \
		echo "âŒ ERROR: Shock tube requires DIM=1 build"; \
		echo "See sample/shock_tube/README.md for details."; \
		exit 1; \
	fi
	@if [ -z "$(CHECKPOINT)" ]; then \
		echo "No CHECKPOINT specified, finding latest snapshot..."; \
		LATEST=$$(ls -t $(SHOCK_TUBE_RESULTS_DIR)/snapshot_*.csv 2>/dev/null | head -1); \
		if [ -z "$$LATEST" ]; then \
			echo "ERROR: No snapshots found in $(SHOCK_TUBE_RESULTS_DIR)/"; \
			echo ""; \
			echo "Usage:"; \
			echo "  make shock_tube_resume                              # Use latest snapshot"; \
			echo "  make shock_tube_resume CHECKPOINT=snapshot_0005.csv # Use specific snapshot"; \
			echo ""; \
			exit 1; \
		fi; \
		echo "âœ“ Found latest snapshot: $$LATEST"; \
		$(MAKE) shock_tube_resume CHECKPOINT=$$LATEST; \
	else \
		echo "Checkpoint file: $(CHECKPOINT)"; \
		echo ""; \
		echo "Creating resume configuration (SSOT mode)..."; \
		python3 -c "import json; \
			resume_config = { \
				'checkpoint': {'resumeFile': '$(CHECKPOINT)'}, \
				'outputDirectory': '$(SHOCK_TUBE_RESULTS_DIR)', \
				'endTime': 0.4, \
				'outputTime': 0.01 \
			}; \
			json.dump(resume_config, open('$(SHOCK_TUBE_DIR)/shock_tube.json', 'w'), indent=2)"; \
		echo "âœ“ Resume config created"; \
		echo ""; \
		echo "Running simulation from checkpoint..."; \
		./build/sph shock_tube; \
		echo ""; \
		echo "âœ“ Resumed simulation complete!"; \
		echo "ðŸ“ Results saved to: $(SHOCK_TUBE_RESULTS_DIR)"; \
	fi

# Clean results
shock_tube_clean:
	@echo "Cleaning shock tube results..."
	@rm -rf $(SHOCK_TUBE_RESULTS_DIR)
	@echo "âœ“ Results cleaned"

# Visualize results
shock_tube_animate:
	@echo "=========================================="
	@echo "Visualizing Shock Tube Results"
	@echo "=========================================="
	@if [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)" ] || [ -z "$$(ls -A $(SHOCK_TUBE_RESULTS_DIR)/snapshot_*.csv 2>/dev/null)" ]; then \
		echo "ERROR: No results found in $(SHOCK_TUBE_RESULTS_DIR)/"; \
		echo "Run 'make shock_tube_run' first to generate data."; \
		exit 1; \
	fi
	@echo "Data directory: $(SHOCK_TUBE_RESULTS_DIR)"
	@python3 $(SHOCK_TUBE_DIR)/scripts/visualize_shock_tube.py $(SHOCK_TUBE_RESULTS_DIR) shock_tube_sod
	@echo ""
	@echo "âœ“ Visualization complete!"
	@echo "ðŸ“Š Generated files in $(SHOCK_TUBE_RESULTS_DIR):"
	@ls -lh $(SHOCK_TUBE_RESULTS_DIR)/shock_tube_sod_*.png $(SHOCK_TUBE_RESULTS_DIR)/shock_tube_sod_*.gif 2>/dev/null || true

# Help
shock_tube_help:
	@echo "Shock Tube Makefile Targets"
	@echo "============================"
	@echo ""
	@echo "Single Method Targets:"
	@echo "  shock_tube_run     - Run Sod shock tube test (SSPH)"
	@echo "  shock_tube_resume  - Resume from latest snapshot"
	@echo "  shock_tube_animate - Generate plots and animation"
	@echo "  shock_tube_clean   - Clean results"
	@echo ""
	@echo "Riemann Solver Comparison:"
	@echo "  shock_tube_iterative_run     - Run GSPH with iterative Riemann solver"
	@echo "  shock_tube_iterative_animate - Animate iterative solver results"
	@echo "  shock_tube_iterative_all     - Run + animate iterative (one-shot)"
	@echo "  shock_tube_hll_run           - Run GSPH with HLL Riemann solver"
	@echo "  shock_tube_hll_animate       - Animate HLL solver results"
	@echo "  shock_tube_riemann_compare   - Compare HLL vs Iterative solvers"
	@echo ""
	@echo "Multi-Method Comparison Targets:"
	@echo "  shock_tube_compare_run     - Run all 5 SPH methods"
	@echo "  shock_tube_compare_viz     - Generate comparison plots"
	@echo "  shock_tube_compare_animate - Generate comparison animation"
	@echo "  shock_tube_compare_all     - Run all + generate visualizations"
	@echo "  shock_tube_compare_clean   - Clean all comparison results"
	@echo ""
	@echo "Examples:"
	@echo "  make shock_tube_run"
	@echo "  make shock_tube_iterative_all"
	@echo "  make shock_tube_compare_all"
	@echo "  make shock_tube_resume CHECKPOINT=sample/shock_tube/results/snapshot_0005.csv"

# ============================================================================
# Riemann Solver Comparison Targets
# ============================================================================

# Run GSPH with iterative Riemann solver
shock_tube_iterative_run: build/sph
	@echo "=========================================="
	@echo "Shock Tube: GSPH with Iterative Solver"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "SPH_DIM:STRING=1" build/CMakeCache.txt 2>/dev/null; then \
		echo "âœ“ DIM=1 build detected"; \
	else \
		echo "âŒ ERROR: Shock tube requires DIM=1 build"; \
		echo "See sample/shock_tube/README.md for details."; \
		exit 1; \
	fi
	@echo "Applying GSPH iterative solver preset..."
	@cp $(SHOCK_TUBE_PRESET_DIR)/shock_tube_1d_gsph_iterative.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative
	@echo "Output directory: $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative"
	@echo "Running simulation..."
	@./build/sph shock_tube
	@echo ""
	@echo "âœ“ Simulation complete!"
	@echo "ðŸ“ Results saved to: $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative"

# Animate iterative solver results
shock_tube_iterative_animate:
	@echo "=========================================="
	@echo "Visualizing Iterative Solver Results"
	@echo "=========================================="
	@if [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative" ] || [ -z "$$(ls -A $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative/snapshot_*.csv 2>/dev/null)" ]; then \
		echo "ERROR: No results found in $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative/"; \
		echo "Run 'make shock_tube_iterative_run' first."; \
		exit 1; \
	fi
	@echo "Data directory: $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative"
	@python3 $(SHOCK_TUBE_DIR)/scripts/visualize_shock_tube.py $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative gsph_iterative
	@echo ""
	@echo "âœ“ Visualization complete!"
	@echo "ðŸ“Š Generated files in $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative:"
	@ls -lh $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative/gsph_iterative_*.png $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative/gsph_iterative_*.gif 2>/dev/null || true

# One-shot: run iterative solver and animate
shock_tube_iterative_all: shock_tube_iterative_run shock_tube_iterative_animate
	@echo ""
	@echo "=========================================="
	@echo "âœ“ Iterative Solver Workflow Complete!"
	@echo "=========================================="
	@echo "ðŸ“ All results in: $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative/"

# Run GSPH with HLL Riemann solver
shock_tube_hll_run: build/sph
	@echo "=========================================="
	@echo "Shock Tube: GSPH with HLL Solver"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "SPH_DIM:STRING=1" build/CMakeCache.txt 2>/dev/null; then \
		echo "âœ“ DIM=1 build detected"; \
	else \
		echo "âŒ ERROR: Shock tube requires DIM=1 build"; \
		echo "See sample/shock_tube/README.md for details."; \
		exit 1; \
	fi
	@echo "Applying GSPH HLL solver preset..."
	@cp $(SHOCK_TUBE_PRESET_DIR)/shock_tube_1d_gsph_hll.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll
	@echo "Output directory: $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll"
	@echo "Running simulation..."
	@./build/sph shock_tube
	@echo ""
	@echo "âœ“ Simulation complete!"
	@echo "ðŸ“ Results saved to: $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll"

# Animate HLL solver results
shock_tube_hll_animate:
	@echo "=========================================="
	@echo "Visualizing HLL Solver Results"
	@echo "=========================================="
	@if [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)/gsph_hll" ] || [ -z "$$(ls -A $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll/snapshot_*.csv 2>/dev/null)" ]; then \
		echo "ERROR: No results found in $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll/"; \
		echo "Run 'make shock_tube_hll_run' first."; \
		exit 1; \
	fi
	@echo "Data directory: $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll"
	@python3 $(SHOCK_TUBE_DIR)/scripts/visualize_shock_tube.py $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll gsph_hll
	@echo ""
	@echo "âœ“ Visualization complete!"
	@echo "ðŸ“Š Generated files in $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll:"
	@ls -lh $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll/gsph_hll_*.png $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll/gsph_hll_*.gif 2>/dev/null || true

# Compare HLL vs Iterative Riemann solvers
shock_tube_riemann_compare:
	@echo "=========================================="
	@echo "Riemann Solver Comparison: HLL vs Iterative"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "SPH_DIM:STRING=1" build/CMakeCache.txt 2>/dev/null; then \
		echo "âœ“ DIM=1 build detected"; \
	else \
		echo "âŒ ERROR: Shock tube requires DIM=1 build"; \
		exit 1; \
	fi
	@echo ""
	@echo "[1/2] Running HLL solver..."
	@echo "----------------------------------------"
	@cp $(SHOCK_TUBE_PRESET_DIR)/shock_tube_1d_gsph_hll.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll
	@./build/sph shock_tube
	@echo "âœ“ HLL complete"
	@echo ""
	@echo "[2/2] Running Iterative solver..."
	@echo "----------------------------------------"
	@cp $(SHOCK_TUBE_PRESET_DIR)/shock_tube_1d_gsph_iterative.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative
	@./build/sph shock_tube
	@echo "âœ“ Iterative complete"
	@echo ""
	@echo "Generating comparison plots..."
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/riemann_comparison
	@python3 $(SHOCK_TUBE_DIR)/scripts/compare_riemann.py $(SHOCK_TUBE_RESULTS_DIR) $(SHOCK_TUBE_RESULTS_DIR)/riemann_comparison
	@echo ""
	@echo "=========================================="
	@echo "âœ“ Riemann Solver Comparison Complete!"
	@echo "=========================================="
	@echo "Results directories:"
	@echo "  ðŸ“ $(SHOCK_TUBE_RESULTS_DIR)/gsph_hll/"
	@echo "  ðŸ“ $(SHOCK_TUBE_RESULTS_DIR)/gsph_iterative/"
	@echo "  ðŸ“Š $(SHOCK_TUBE_RESULTS_DIR)/riemann_comparison/"

# ============================================================================
# Multi-Method Comparison Targets
# ============================================================================

# Run all five SPH methods (GSPH, SSPH, DISPH, GDISPH, GDISPH+Balsara)
shock_tube_compare_run: build/sph
	@echo "=========================================="
	@echo "Shock Tube Multi-Method Comparison"
	@echo "Running: GSPH, SSPH, DISPH, GDISPH, GDISPH+Balsara"
	@echo "=========================================="
	@echo "Checking build configuration..."
	@if grep -q "SPH_DIM:STRING=1" build/CMakeCache.txt 2>/dev/null; then \
		echo "âœ“ DIM=1 build detected"; \
	else \
		echo "âŒ ERROR: Shock tube requires DIM=1 build"; \
		echo "See sample/shock_tube/README.md for details."; \
		exit 1; \
	fi
	@echo ""
	@echo "[1/5] Running GSPH simulation..."
	@echo "----------------------------------------"
	@cp $(SHOCK_TUBE_PRESET_DIR)/shock_tube_1d_gsph.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/gsph
	@./build/sph shock_tube
	@echo "âœ“ GSPH complete"
	@echo ""
	@echo "[2/5] Running SSPH simulation..."
	@echo "----------------------------------------"
	@cp $(SHOCK_TUBE_PRESET_DIR)/shock_tube_1d_ssph.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/ssph
	@./build/sph shock_tube
	@echo "âœ“ SSPH complete"
	@echo ""
	@echo "[3/5] Running DISPH simulation..."
	@echo "----------------------------------------"
	@cp $(SHOCK_TUBE_PRESET_DIR)/shock_tube_1d_disph.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/disph
	@./build/sph shock_tube
	@echo "âœ“ DISPH complete"
	@echo ""
	@echo "[4/5] Running GDISPH simulation..."
	@echo "----------------------------------------"
	@cp $(SHOCK_TUBE_PRESET_DIR)/shock_tube_1d_gdisph.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/gdisph
	@./build/sph shock_tube
	@echo "âœ“ GDISPH complete"
	@echo ""
	@echo "[5/5] Running GDISPH+Balsara simulation..."
	@echo "----------------------------------------"
	@cp $(SHOCK_TUBE_PRESET_DIR)/shock_tube_1d_gdisph_balsara.json $(SHOCK_TUBE_DIR)/shock_tube.json
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/gdisph_balsara
	@./build/sph shock_tube
	@echo "âœ“ GDISPH+Balsara complete"
	@echo ""
	@echo "=========================================="
	@echo "âœ“ All simulations complete!"
	@echo "=========================================="
	@echo "Results directories:"
	@echo "  ðŸ“ $(SHOCK_TUBE_RESULTS_DIR)/gsph/"
	@echo "  ðŸ“ $(SHOCK_TUBE_RESULTS_DIR)/ssph/"
	@echo "  ðŸ“ $(SHOCK_TUBE_RESULTS_DIR)/disph/"
	@echo "  ðŸ“ $(SHOCK_TUBE_RESULTS_DIR)/gdisph/"
	@echo "  ðŸ“ $(SHOCK_TUBE_RESULTS_DIR)/gdisph_balsara/"
	@echo ""
	@echo "Next steps:"
	@echo "  make shock_tube_compare_viz     - Generate comparison plots"
	@echo "  make shock_tube_compare_animate - Generate animation"

# Generate comparison plots
shock_tube_compare_viz:
	@echo "=========================================="
	@echo "Generating Comparison Plots"
	@echo "=========================================="
	@if [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)/gsph" ] || [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)/ssph" ] || [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)/disph" ]; then \
		echo "ERROR: Missing results directories"; \
		echo "Run 'make shock_tube_compare_run' first."; \
		exit 1; \
	fi
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/comparison
	@python3 $(SHOCK_TUBE_DIR)/scripts/compare_shock_tube.py $(SHOCK_TUBE_RESULTS_DIR) $(SHOCK_TUBE_RESULTS_DIR)/comparison
	@echo ""
	@echo "âœ“ Comparison plots generated!"
	@echo "ðŸ“Š Output: $(SHOCK_TUBE_RESULTS_DIR)/comparison/"
	@ls -lh $(SHOCK_TUBE_RESULTS_DIR)/comparison/*.png 2>/dev/null || true

# Generate comparison animation
shock_tube_compare_animate:
	@echo "=========================================="
	@echo "Generating Comparison Animation"
	@echo "=========================================="
	@if [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)/gsph" ] || [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)/ssph" ] || [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)/disph" ] || [ ! -d "$(SHOCK_TUBE_RESULTS_DIR)/gdisph" ]; then \
		echo "ERROR: Missing results directories"; \
		echo "Run 'make shock_tube_compare_run' first."; \
		exit 1; \
	fi
	@mkdir -p $(SHOCK_TUBE_RESULTS_DIR)/comparison
	@python3 $(SHOCK_TUBE_DIR)/scripts/animate_comparison.py $(SHOCK_TUBE_RESULTS_DIR) $(SHOCK_TUBE_RESULTS_DIR)/comparison/comparison_animation.gif
	@echo ""
	@echo "âœ“ Animation complete!"
	@echo "ðŸŽ¬ Output: $(SHOCK_TUBE_RESULTS_DIR)/comparison/comparison_animation.gif"
	@ls -lh $(SHOCK_TUBE_RESULTS_DIR)/comparison/*.gif 2>/dev/null || true

# Run all methods and generate all visualizations
shock_tube_compare_all: shock_tube_compare_run shock_tube_compare_viz shock_tube_compare_animate
	@echo ""
	@echo "=========================================="
	@echo "âœ“ Complete Comparison Workflow Done!"
	@echo "=========================================="

# Clean all comparison results
shock_tube_compare_clean:
	@echo "Cleaning all shock tube comparison results..."
	@rm -rf $(SHOCK_TUBE_RESULTS_DIR)/gsph $(SHOCK_TUBE_RESULTS_DIR)/ssph $(SHOCK_TUBE_RESULTS_DIR)/disph $(SHOCK_TUBE_RESULTS_DIR)/gdisph $(SHOCK_TUBE_RESULTS_DIR)/gdisph_balsara $(SHOCK_TUBE_RESULTS_DIR)/comparison
	@echo "âœ“ All comparison results cleaned"
